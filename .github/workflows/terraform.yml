name: 'Terraform CI'

on:
 push:
  branches:
   - main
 pull_request:

defaults:
 run:
  working-directory: terraform

jobs:
 terraform:
  name: 'Terraform'
  runs-on: ubuntu-latest

  steps:
   - name: Checkout
     uses: actions/checkout@v2

   - name: Setup Terraform
     uses: hashicorp/setup-terraform@v1

   - name: Terraform Init
     run: terraform init -get=true -lock=true -lock-timeout=60m
     env:
      GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
 
   - name: Terraform Format
     run: terraform fmt --check

   - name: Terraform Plan
     run: terraform plan
     env:
      GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}

   - name: Terraform Apply
     if: github.ref == 'refs/heads/main' && github.event_name == 'push'
     run: terraform apply --auto-approve
     env:
      GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}